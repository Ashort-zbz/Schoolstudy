# 存储技术

 :earth_africa: 存储要解决的问题：1、存储海量数据；2、安全的存储；3、高性能的存储

## 第一部分 存储技术概述

数据种类

结构化数据：可以使用关系型数据库表示和存储，常表现为二维表。SQL server，MySQL，Oracle。

半结构化数据：不符合关系型数据库或其他数据表的形式，但使用相关标记分隔语义元素、或对记录和字段分层。XML，HTML，JSON。

非结构化数据：数据结构不规则或不完整，没有预定义的数据模型。文本、图片、各类报表、图像和音频/视频信息。

什么是信息？

信息是已经被处理、具有逻辑关系的数据，是对数据的解释。其中包括具有上下文，相关性和目的的数据。



## 传统磁盘驱动器的读写技术

自20世纪80年代以来，CPU处理性能的提升速度远高于磁盘驱动器的读与迷度的增长率，两者性能上的不匹配严重制约了系统整体性能的提升，而 RAID技术的出现很好地缓解了这一矛盾。RAID 通过使用多磁盘并行存取数据;另外，通过数据校验，RAID可以提供容错功能，提高存储数据的可用性。目前，RAID已成为保障存储性能和数据安全性的一项基本技术。

### RAID基本概念

磁盘阵列（Redundant Array of Independent Disks，RAID）的全称是独立冗余磁盘阵列，最初是美国加州大学伯克利分校于1987年提出的，它将两个或两个以上单独的物理磁盘以不同的方式组合成一个逻辑盘组。

RAID技术的优势主要体现在三个方面:（1）将多个磁盘组合成一个逻辑盘组，以提供更大容量的存储；（2）将数据分割成数据块，由多个磁盘同时进行数据块的写入/读出，以提高访问速度（3）通过数据镜像或奇偶校验提供数据冗余保护，以提高数据安全性。

实现RAID主要有两种方式：软件RAID和硬件RAID。

（1）基于软件的RAID技术

通过在主机操作系统上安装相关软件实现，在操作系统底层运行RAID程序，将识别到的多个物理磁盘按一定的RAID策略虚拟成逻辑磁盘;然后将这个逻辑磁盘映射给磁盘管理器，由磁盘管理器对其进行格式化。上层应用可以透明地访问格式化后的逻辑磁盘，察觉不到逻辑磁盘是由多个物理磁盘构成。上述所有操作都是依赖于主机处理器实现的，软件RAID会占用主机CPU资源和内存空间，因此，低速CPU可能无法实施，软件RAID通常用于企业级服务器。但是，软件RAID具有成本低、配置灵活、管理方便等优势。

（2）基于硬件的RAID技术

通过独立硬件来实现RAID功能，包括采用集成RAID芯片的SCSI适配卡（即 RAID卡）或集成RAID芯片的磁盘控制器（即RAID控制器)。RAID适配卡和RAID控制器都拥有自己独立的控制处理器、I/0处理芯片、存储器和RAID芯片。硬件RAID采用专门RAID芯片来实现RAID功能，不再依赖于主机 CPU和内存。相比软件RAID，硬件RAID不但释放了主机CPU压力，提高了性能，而且操作系统也可以安装在RAID虚拟磁盘之上，能够进行相应的冗余保护。

### RAID技术

#### 关键技术

RAID技术之所以能够在提高读写性能的同时保证数据的安全性，是因为采用了数据条带化这一高效数据组织方式以及奇偶校验这一数据冗余策略。

1.条带化技术

RAID条带化技术就是一种自动的将 I/O 的负载均衡到多个物理磁盘上的技术，条带化技术就是将一块连续的数据分成很多小部分并把他们分别存储到不同磁盘上去。这就能使多个进程同时访问数据的多个不同部分而不会造成磁盘冲突，而且在需要对这种数据进行顺序访问的时候可以获得最大程度上的 I/O 并行能力，从而获得非常好的性能。由于条带化在 I/O 性能问题上的优越表现，以致于在应用系统所在的计算环境中的多个层次或平台都涉及到了条带化的技术，如操作系统和存储系统这两个层次中都可能使用条带化技术。

（1）条带 (strip)：硬盘中单个或者多个连续的扇区构成一个条带，是组成分条的元素。RAID条带深度指的是条带的大小，也叫条带大小。有时也被叫做block size, chunk size, stripe length 或者 granularity。这个参数指的是写在每块磁盘上的条带数据块的大小。RAID的数据块大小一般在2KB到512KB之间(或者更大)，其数值是2的次方，即2KB,4KB,8KB,16KB这样，条带大小对性能的影响比条带宽度难以量化的多。

- 减小条带大小: 由于条带大小减小了，则文件被分成了更多个，更小的数据块。这些数据块会被分散到更多的硬盘上存储，因此提高了传输的性能，但是由于要多次寻找不同的数据块，磁盘定位的性能就下降了。
- 增加条带大小: 与减小条带大小相反，会降低传输性能，提高定位性能。

根据上边的论述，我们会发现根据不同的应用类型，不同的性能需求，不同驱动器的不同特点(如SSD硬盘)，不存在一个普遍适用的"最佳条带大小"。所以这也是存储厂家，文件系统编写者允许我们自己定义条带大小的原因。

（2）分条 (stripe)：同一硬盘阵列中的多个硬盘驱动器上的相同“位置”（或者说是相同编号）的条带。

RAID条带宽度是指同时可以并发读或写的条带数量。这个数量等于RAID中的物理硬盘数量。例如一个经过条带化的，具有4块物理硬盘的阵列的条带宽度就是4。增加条带宽度，可以增加阵列的读写性能。道理很明显，增加更多的硬盘，也就增加了可以同时并发读或写的条带数量。在其他条件一样的前提下，一个由8块18G硬盘组成的阵列相比一个由4块36G硬盘组成的阵列具有更高的传输性能。

![image.png](https://upload-images.jianshu.io/upload_images/19680844-e369bf8a3e3ae3e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

2.奇偶校验

RAID通过镜像和奇偶校验的方式对磁盘数据进行冗余保护。

镜像是指利用冗余的磁盘保存数据的副本，一个数据盘对应一个镜像备份盘。

奇偶校验则是指用户数据通过奇偶校验算法计算出奇偶校验码，并将其保存于额外的存储空间。奇偶校验采用的是异或运算（运算符为）算法。奇偶校验具体过程：0⊕0= 0； 0⊕1= 1； 1⊕0= 1； 1⊕1= 0，即，相同为假，相异为真。

![image.png](https://upload-images.jianshu.io/upload_images/19680844-d4a88120753898ce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### JBOD和RAID级别

在RAID技术出现之前，出现过一种类似于RAID的磁盘簇(Just a Bundle Of Disks，JBOD）技术，可以理解为“仅仅只是一堆磁盘”。JBOD技术只是将多个小容量的磁盘组合成一个大容量的逻辑磁盘，它没有条带的概念，数据块不能被多个磁盘同时读写。在JBOD中，只有将第一块磁盘的存储空间使用完，才会使用第二块磁盘，因此，JBOD可用容量为所有磁盘容量的总和，但读写性能和单个的磁盘毫无差异。在JBOD的基础上，引入了按条带方式写入数据的数据组织方式，以镜像或奇偶校验为基础的数据冗余策略，就发展成了RAID技术。

根据不同的冗余策略和不同的数据访问模块，可以将RAID划分为不同的等级。常见的RAID级别有RAID 0、RAID 1、RAID 2、RAID 3、RAID 4、RAID 5以及RAID 6。各级别的RAID既有各自的优势，也有不足，为了实现优势互补，自然而然地就想到把多个RAID等级组合起来，以此来获得具备更高性能和数据安全性的RAID组合等级，如RAID00、RAID 01、RAID 10、RAID 100、RAID 30、RAID 50、RAID 53以及RAID 60。众多RAID组合等级中，能在实际中得到广泛应用的很少，下面主要介绍RAID 0、RAID 1、RAID 5、RAID 6、RAID 01、RAID 10 以及RAID 50这些常用的RAID等级。

#### RAID工作原理

1.RAID 0

RAID 0是一种无数据校验的、简单的并且是所有RAID级别中有最高的存储性能的数据条带化技术。RAID 0从原理上算不上真正的RAID，因为**它并不支持数据冗余策略**。

![image.png](https://upload-images.jianshu.io/upload_images/19680844-d35bb89525cf986a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

RAID 0充分利用总线带宽，将数据分散存储在所有磁盘中，实现多块物理磁盘并发/并行执行I/0操作，使得访问性能得到很大的提升。此外，它无数据冗余策略，不需要进行数据镜像备份和校验运算，使得RAID 0成为所有RAID等级中性能最好的阵列。理论上讲，一个由N块物理磁盘组成的RAID 0组，它的读写性能是单块物理磁盘性能的N倍。但受制于CPU处理能力、总线带宽、内存大小等因素，RAID 0实际的性能提升低于理论值。RAID 0不提供数据冗余保护，只要磁盘组中一块磁盘失效那么磁盘数据就失效，并无法得到恢复。此外，磁盘组中任何一个磁盘数据失效，都可能导致整个逻辑磁盘的数据因为部分丢失而不可用。因此，RAID 0一般适用于对性能要求很高但对数据安全性要求不高的应用场景，如临时数据缓存、视频/音频存储等。

![RAID 0 工作原理](https://upload-images.jianshu.io/upload_images/19680844-1f875cdf8e953f89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

写数据时，RAID0采用条带化技术将数据写入磁盘组中，它将数据分为数据块，按条带写入，均匀地存储在 RAID组中的所有磁盘上。只有当RAID组的即一个余市悦蚁掂块写满后，数据才会写入到下一个条带。如图 4-4所示，数据块DO、D1、D2、D3、D4、D5将被按条带化方式依次写入磁盘组，数据块DO、D1将同时被写入条带0中，分别与入磁盘О和磁盘1的相应条带单元上，数据块D2、D3将同时被写入条带1中，数据块D4、D5将同时被写入条带2中，依此类推，直至组中成员磁盘共同完成一个数据写入任务。由此可知，数据写入性能与成员磁盘的数量成正比。

读数据时，RAID O接收到数据读取请求，它会在所有磁盘上搜索并读取目标数据块,经过整合后将数据返回给主机。如图4-4所示，假设阵列收到读取数据块DO、D1、D2、D3、D4、D5的请求，数据块DO、D1将从条带0中同时被读取，数据块D2、D3将从条带1中同时被读取，数据块D4、D5也将从条带2中同时被读取，依此类推，当所有的数据块从磁盘被读取后，经RAID控制器整合后发送给主机。和数据的写入同理，RAID 0的读取性能与组中成员磁盘的数量成正比。

2.RAID 1

RAID1又称为**镜像（Mirroring)**，是具有**全冗余的阵列模式**。RAID 1包括一个数据磁盘（数据盘)，一个或者多个备用磁盘（镜像盘)。每次写数据时，数据盘上的数据将完全地备份到镜像盘中。当数据盘失效时，镜像盘会接管数据盘的业务，保证业务的连续性。

![RAID 1](https://upload-images.jianshu.io/upload_images/19680844-bb9ead1e0f5b3fb3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

镜像盘作为备份，可显著提高数据的可用性。由于RAID 1阵列中一个磁盘保存数据，另一磁盘保存的是数据的副本，因此RAID 1的空间利用率是50%。

RAID 1采用条带化技术将相同的数据并行写入到磁盘中。RAID 1读取数据的时候，会同时读取数据盘和镜像盘上的数据，以提高读取性能。如果在其中一个磁盘中读操作执行失败，则可以从另一个磁盘读取数据。

![RAID 1工作原理](https://upload-images.jianshu.io/upload_images/19680844-3febb20ece82fd8a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

需要特别注意的是，当RAID 1磁盘组在正常工作时，成员盘（即组成磁盘组1的磁盘）发生故障或掉线，会由工作状态进入降级状态。假设上图中磁盘0发生故障，RAID 1磁盘组进入降级状态，此时只能从磁盘1中读取数据，因此,相比工作状态，降级状态下读性能会下降一半。

在数据恢复时，当RAID 1组中有磁盘失效时，只要新磁盘数据没有完成重建，RAID 1就处于降级状态，而当单个磁盘的容量越高，需要恢复的数据就越多，数据重建时间就会越长。

3.RAID 2

![image.png](https://upload-images.jianshu.io/upload_images/19680844-6e57e82e0da02b76.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

RAID 2是为大型机和超级计算机开发的带汉明码校验磁盘阵列。它是将数据条带化地分布于不同的硬盘上，条块单位为位或者字节，并使用“加重平均纠错码”的编码技术来提供错误检查及恢复，这种纠错码也被称为“海明码”。海明码需要多个磁盘存放检查及恢复信息，使得RAID2技术实施更复杂，因此**在商业环境中很少使用**。

4.RAID 3

![RAID 3](https://upload-images.jianshu.io/upload_images/19680844-75f7494c35643936.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

RAID 3是把数据分成多个“块”，按照一定的容错算法，存放在N+1个硬盘上，实际数据占用的有效空间为N个硬盘的空间总和，而第N+1个硬盘上存储的数据是校验容错信息，当这N+1个硬盘中的其中一个硬盘出现故障时，从其它N个硬盘中的数据也可以恢复原始数据，这样，仅使用这N个硬盘也可以带伤继续工作（如采集和回放素材），当更换一个新硬盘后，系统可以重新恢复完整的校验容错信息。由于在一个硬盘阵列中，多于一个硬盘同时出现故障率的几率很小，所以一般情况下，使用RAID3，安全性是可以得到保障的。

如下图所示，假设RAID 3由4块盘组成，磁盘0、磁盘1和磁盘2作为数据盘，磁盘3作为校验盘，A、B、C为需要读写的数据。

![RAID 3工作原理](https://upload-images.jianshu.io/upload_images/19680844-4ee32ffdc35f2852.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

写数据时，RAID 3采用并行方式写入数据。假设数据A、B、C将依次被写入磁盘组中，整个过程如下:首先，收到写请求之后，控制器对数据进行分块，数据A被分拆成数据块A0、A1、A2，将这三个数据块进行异或运算得到校验数据块P1：将数据块A0、A1、A2、P1同时写入同一条带上（分别落于磁盘0、磁盘1、磁盘2、磁盘3的相应条带单元上)。同理，数据B和C以同样的方式被写入磁盘组中。RAID 3组中成员盘共同完成一个数据写入任务，理论上数据写入性能与数据盘的数量成正比。

读数据时，其和写数据过程类似，RAID 3采用并行方式读取数据。假如阵列收到读取数据A、B、C的请求，数据块 A0、A1、A2将从对应条带单元中同时被读取，经RAID控制器整合后发送给主机。数据B和C 以同样的方式被读取，理论上RAID 3的读性能与数据盘的数量成正比。

在正常工作状态下，RAID 3数据读取时没有用到校验盘，数据盘支持对读请求的并发/并行响应，读性能非常高。而在写数据时，RAID 3会把数据的写入操作分散到多个磁盘上进行，然而不管是向哪一个数据盘写入数据，都需要同时重写校验盘中的相关信息。因此，**对于那些经常需要执行大量写入操作的随机业务来说，校验盘的负载将会很大，而且校验盘在同一时刻只能响应一个写操作，这将导致RAID 3不能支持对多个写请求的并发响应，此时整个系统写操作性能较低**。而对于数据连续的顺序业务而言，数据块一般能满条带写入，每写一个条带计算一块校验数据即可。因此RAID 3可以支持一个写请求的并行响应，此时整个系统的写操作性能相对较高。

当RAID 3磁盘组中某一块磁盘发生故障时，RAID 3通过对剩余数据盘上的数据块和校验盘上的校验数据做异或计算，重构出故障盘上原有的数据。例如当磁盘0出现故障时，其存储的数据块A0、B0、C0丢失，故障盘失效恢复需要经历如下过程：将与数据块A0同一条带上数据块A1、A2和校验块P1从各自磁盘中取出，进行异或运算得到数据块A0，从而恢复出数据块A0；同理，还可以恢复出数据块B0和C0。如此循环，直至恢复出磁盘0上的所有数据。

5.RAID 5

RAID 5是目前最常用的RAID等级，通过条带化形式将数据写入磁盘组中。与RAID 3类似，RAID 5每个条带上都有一份校验数据，不同之处在于RAID 5不同条带上的校验数据不是单独存在一个固定的校验盘里的，而是**按一定规律分散存放在阵列的各个磁盘里**。

阵列中每个磁盘都存储有数据块和校验数据，当数据块按条带方式写入时，校验数据也同时被写入该条带的某个磁盘的条带单元里。因此，RAID 5不存在RAID 3中并发写操作时校验盘性能瓶颈问题。另外，RAID 5还**具备很好的扩展性**，当阵列磁盘数量增加时，并行操作能力也随之增强，从而拥有更大的容量以及更高的性能。

RAID 5的磁盘上同时存储数据和校验数据，同条带的数据块和对应的校验信息保存在不同的磁盘上。当一个数据盘损坏时，系统可以根据同一条带的其他数据块和校验数据来重建失效的数据 。处于降级状态进行数据重构时，RAID 5的用户访问性能会受到较大的影响。RAID 5兼顾存储性能、数据安全和存储成本等各方面因素，基本上可以满足大部分存储应用需求，因此，数据中心大多采用RAID 5作为数据的保护方案。

![image.png](https://upload-images.jianshu.io/upload_images/19680844-ae8c72b00d8d2cbc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

RAID 5使用的是分布式奇偶校验，每个成员盘都存放用户数据和校验数据。由于没有用专门的校验盘来保存校验数据，RAID 5不存在校验盘性能瓶颈或热点问题。假设一个RAID 5的磁盘数为N，则其中有效用户数据存储容量数为N-1。在RAID 3和 RAID 5的磁盘阵列中，如果一个磁盘失效，则该磁盘组将从正常工作（在线）状态转变为降级状态，并在降级状态下完成丢失数据的重构。如果重构过程中另一个磁盘也出现故障，则磁盘组的数据将会永久丢失。

下面以一个简单例子来说明RAID 5的读写过程。如下图所示，磁盘0、磁盘1、磁盘2组成了一个RAID 5，数据块D0、D1、D2、D3、D4、D5是需要存取的数据。

![RAID 5工作原理](https://upload-images.jianshu.io/upload_images/19680844-5af8f20c7cf5138f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

写数据时，RAID 5按条带进行。各个磁盘上既存储数据块，又存储校验数据。假设数据块D0、D1、D2、D3、D4、D5将依次被写入磁盘组，写入过程如下：首先，利用数据D0、D1进行异或运算得到校验数据P0；而后将数据块D0、D1、P0按条带化方式同时写入，分别落于磁盘0、磁盘1和磁盘2的相应条带单元上。以同样的方式,将数据块D2、D3、D4、D5 及其校验数据P1、P2写入磁盘中，由于采用分布式校验数据布局，校验数据PO、P1、P2分别落在磁盘2、磁盘1、磁盘0中。

读数据时，RAID5只读取磁盘中的用户数据块，而不需读取校验数据。假设阵列收到读取数据块D0、D1、D2、D3、D4、D5的请求，数据块D0、D1将同时从磁盘0和磁盘1中被读取，随后，数据块D2、D3将同时从磁盘0和磁盘2中被读取，数据块D4、D5也将同时从磁盘1和磁盘2中被读取，所有的数据块从磁盘被读取后，经RAID控制器整合后发送给主机。

在RAID 5中，如果有一块磁盘失效，可对其他成员磁盘进行异或运算，恢复出故障磁盘上的数据。如果，磁盘0数据失效，该磁盘上数据块D0、D2和校验数据P2丢失。首先恢复数据块D0，将与数据块D0同一条带上数据块D1和P0从各自磁盘中读取出，进行异或运算得到数据D0;再用相同方法恢复出数据块D2和P2，直至将磁盘0上的数据全部恢复。

6.RAID 6

前面所述的RAID 1、RAID 3和 RAID 5都只能保护因单个磁盘失效而造成的数据丢失，如果两个磁盘同时发生故障，数据将无法恢复。RAID 6引入双重校验的概念，常用的校验方式有两种：一种是 P+O校验，另一种是DP校验。
